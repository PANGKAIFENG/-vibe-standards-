# 全局 AI 协作开发规范 v1.0

> 📌 **本文件是所有项目的"宪法"级规则**。  
> 所有项目的 `.cursorrules` / `CLAUDE.md` 必须引用本文件。

---

## 1. 通用原则 (Universal)

### 1.1 类型安全
- **禁止 `any`**：所有 TypeScript 代码禁止使用 `any` 类型。
- **强制 `import type`**：类型导入必须使用 `import type { X }` 语法，避免值导入错误。
- **启用 `verbatimModuleSyntax`**：TypeScript 项目必须在 `tsconfig*.json` 开启 `"verbatimModuleSyntax": true`，用编译期约束杜绝“类型被当作值导入”引发的运行时白屏。

### 1.2 原子化提交
- **提交分离**：`feat` (新功能)、`fix` (Bug修复)、`refactor` (重构) 必须分开提交。
- **禁忌**：严禁在一个 commit 中同时包含功能代码和重构代码。

### 1.3 防退化 (Safety First)
- **核心算法必须有测试**：凡涉及计算、排序、状态机、碰撞检测等核心逻辑，必须配套单元测试。
- **删除代码需回归验证**：不得在未验证影响范围的情况下删除已有逻辑。
- **高风险改动必须有开关**：对核心交互/算法（如拖拽引擎、碰撞检测）进行重写时，必须引入可配置 Feature Toggle，确保可一键回滚到旧逻辑。

---

## 2. 前端规范 (Frontend)

### 2.1 架构隔离
- **组件大小限制**：单个组件文件超过 **300 行**必须考虑拆分。
- **逻辑抽离**：复杂逻辑 (拖拽、时间计算等) 必须抽离为 **Custom Hooks** 或 **纯函数 Utils**。

### 2.2 DOM 操作安全
- **选择器唯一性**：对 DOM 元素的选择必须确保选择器在当前上下文中是唯一的。禁止在未明确作用域的情况下使用通用 class 名（如 `.item`, `.container`）作为选择器。
  - **案例**：`document.querySelector('.custom-scrollbar')` 在多泳道场景下会选错元素。
- **运行时标识唯一性**：凡用于“命中/路由/定位”的标识必须全局唯一（不仅是 DOM selector）。
  - 包括：`id`、`data-testid`、DND 库的 `draggableId/droppableId`（如 dnd-kit 的 `id`）、以及任何跨组件的事件查找键。
  - **规则**：必须带作用域前缀（如 `lane:${laneId}:timeline:${hour}`），禁止在多实例组件中使用静态/裸前缀（如 `timeline-10`）。
- **避免直接 DOM 查询**：React/前端组件内优先使用 `ref`/`useId`，避免 `document.getElementById/querySelector`；若必须使用，必须保证唯一性并限定作用域（例如从容器 `ref` 下查询）。

### 2.3 UI 还原
- **100% 还原 PRD**：代码实现必须严格还原 PRD 中的 UI 设计稿。

### 2.4 交互性能预算
- **定义 SLO**：拖拽/缩放/滚动等指针驱动交互必须满足“无卡顿”，目标延迟 `< 100ms`（需求侧可给出更严格指标）。
- **实现约束**：`pointermove/dragmove` 等高频回调中禁止执行重计算与强制同步布局；必须使用 `requestAnimationFrame`、缓存与增量计算（必要时用 `ref` 存状态）来维持 60fps。
- **验证方式**：高频交互改动需提供自测说明（DevTools Performance 录制截图/结论）或自动化用例（E2E/关键单元测试）证明未退化。

---

## 3. 后端规范 (Backend)

*(待后续项目贡献补充)*

---

## 4. AI 协作规范 (AI Collab)

### 4.1 文档闭环
- **任何复杂功能，必须配齐**：
  1. `PRD_需求文档.md` (含 UI 图)
  2. `TS_技术方案.md`
  3. `TEST_测试用例.md`
- **严禁在缺失闭环文档的情况下开始编码**。

### 4.2 复盘驱动进化
- **每次 Bug 复盘后**，判断是否可抽象为通用规则。
- **若可沉淀**，则更新本文件并提交至全局规范仓库。

### 4.3 异步数据加载防闪烁
- **本地优先 + 后台同步**：有本地缓存/离线库时，优先从本地加载首屏；网络同步放到后台完成后再刷新数据。
- **切换上下文先清状态**：日期/项目等关键上下文切换时，必须先清理旧状态，避免 UI “闪现上一上下文的数据”。

---

## 5. 规则演进流程

1.  **开发中遇到问题** → 解决问题
2.  **复盘** → 归因分析，判断是否为通用陷阱
3.  **抽象** → 将具体问题提炼为通用规则
4.  **提交** → `git commit -m "feat(rules): ..."`
5.  **传播** → 其他项目下次会话自动生效

---

*本规范由所有项目的开发复盘持续"喂养"，是活的知识库。*
